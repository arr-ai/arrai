name: Go wasm
on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'
jobs:
  build:
    name: Build and Test Wasm
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go 1.16
      uses: actions/setup-go@v1
      with:
        go-version: 1.16
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v1

    - name: Get dependencies
      run: go get -v -t -d ./...

    - name: Build
      run: GOOS=js GOARCH=wasm go build -o arrai.wasm ./cmd/arrai

    - name: Set up Node
      uses: actions/setup-node@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run tests
      run: |
        # wasm_exec.js crashes if the environment is too big.
        for v in ACCEPT_EULA AGENT_TOOLSDIRECTORY ANDROID_HOME ANDROID_NDK_HOME ANDROID_NDK_LATEST_HOME ANDROID_NDK_ROOT ANDROID_SDK_ROOT ANT_HOME AZURE_EXTENSION_DIR BOOTSTRAP_HASKELL_NONINTERACTIVE CHROME_BIN CHROMEWEBDRIVER CI CONDA DEBIAN_FRONTEND DEPLOYMENT_BASEPATH DOTNET_MULTILEVEL_LOOKUP DOTNET_NOLOGO DOTNET_SKIP_FIRST_TIME_EXPERIENCE GECKOWEBDRIVER GITHUB_ACTION_REF GITHUB_ACTION_REPOSITORY GITHUB_ACTION GITHUB_ACTIONS GITHUB_ACTOR GITHUB_API_URL GITHUB_BASE_REF GITHUB_ENV GITHUB_EVENT_NAME GITHUB_EVENT_PATH GITHUB_GRAPHQL_URL GITHUB_HEAD_REF GITHUB_JOB GITHUB_PATH GITHUB_REF GITHUB_REPOSITORY_OWNER GITHUB_REPOSITORY GITHUB_RETENTION_DAYS GITHUB_RUN_ATTEMPT GITHUB_RUN_ID GITHUB_RUN_NUMBER GITHUB_SERVER_URL GITHUB_SHA GITHUB_TOKEN GITHUB_WORKFLOW GITHUB_WORKSPACE GRAALVM_11_ROOT GRADLE_HOME HOMEBREW_CELLAR HOMEBREW_CLEANUP_PERIODIC_FULL_DAYS HOMEBREW_NO_AUTO_UPDATE HOMEBREW_PREFIX HOMEBREW_REPOSITORY HOMEBREW_SHELLENV_PREFIX ImageOS ImageVersion INVOCATION_ID JAVA_HOME_11_X64 JAVA_HOME_8_X64 JAVA_HOME JOURNAL_STREAM LEIN_HOME LEIN_JAR NPM_AUTH_TOKEN NVM_DIR PERFLOG_LOCATION_SETTING PIPX_BIN_DIR PIPX_HOME POWERSHELL_DISTRIBUTION_CHANNEL RUNNER_NAME RUNNER_OS RUNNER_PERFLOG RUNNER_TEMP RUNNER_TOOL_CACHE RUNNER_TRACKING_ID RUNNER_USER RUNNER_WORKSPACE SELENIUM_JAR_PATH SGX_AESM_ADDR STATS_KEEPALIVE SWIFT_PATH VCPKG_INSTALLATION_ROOT XDG_CONFIG_HOME; do
          unset $v
        done
        echo '**** env'
        env
        echo '**** node'
        node $(go env GOROOT)/misc/wasm/wasm_exec.js arrai.wasm eval '1 + 5'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_AUTH_TOKEN: "SOME-RANDOM-KEY"
